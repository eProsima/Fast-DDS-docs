.. _flow-controllers:

Flow Controllers
----------------

*eProsima Fast DDS* provides a mechanism to limit the rate at which the data is sent by a DataWriter.
These controllers should be registered on the creation of the DomainParticipant using |FlowControllersQos|, and
then referenced by the DataWriter whose traffic is to be controlled:

* User DataWriters:
  The flow controller should be assigned through |PublishModeQosPolicy| to regulate the transmission of application
  data.
* Built-in DataWriters:
  The flow controller can be configured to control meta-traffic generated by built-in DataWriters responsible for
  PDP and EDP (|DiscoveryProtocol|); WLP (|LivelinessQosPolicy|), and TypeLookupService
  (|TypeObject|). This allows for fine-grained control over discovery and built-in traffic. The flow
  controller should be assigned through |WireProtocolConfigQos|.

A new thread is spawned the first time a flow controller is referenced by an asynchronous DataWriter.
This thread will be responsible for arbitrating the network output of the samples being transmitted by all the
DataWriters referencing the same flow controller.

Flow controllers should be given a name so they can later on be referenced by the DataWriters.
A default, unlimited, |FIFO_SCHED_POLICY-api| flow controller is always available with name
|FASTDDS_FLOW_CONTROLLER_DEFAULT-api|.

Scheduling policy
^^^^^^^^^^^^^^^^^

There are different kinds of flow controllers, depending on the scheduling policy used.
All of them will limit the number of bytes sent to the network to no more than
|FlowControllerDescriptor::max_bytes_per_period-api| bytes during |FlowControllerDescriptor::period_ms-api|
milliseconds.
They only differ in the way they decide the order in which the samples are sent.

* |FIFO_SCHED_POLICY-api| will output samples on a first come, first served order.

* |ROUND_ROBIN_SCHED_POLICY-api| will output one sample from each DataWriter in circular order.

* |HIGH_PRIORITY_SCHED_POLICY-api| will output samples from DataWriters with the highest priority first.
  The priority of a DataWriter is configured using property ``fastdds.sfc.priority``.
  Allowed values are from -10 (highest priority) to 10 (lowest priority).
  If the property is not present, it will be set to the lowest priority.
  Samples for DataWriters with the same priority are handled with FIFO order.

* |PRIORITY_WITH_RESERVATION_SCHED_POLICY-api| works as the previous one, but allows the DataWriters to reserve
  part of the output bandwidth.
  This is done with the property ``fastdds.sfc.bandwidth_reservation``.
  Allowed values are from 0 to 100, and express a percentage of the total flow controller limit.
  If the property is not present, it will be set to 0 (no bandwidth is reserved for the DataWriter).
  After the reserved bandwidth has been consumed, the rest of the samples will be handled with the rules of
  |HIGH_PRIORITY_SCHED_POLICY-api|.


Example configuration
^^^^^^^^^^^^^^^^^^^^^

.. tab-set-code::

    .. literalinclude:: /../code/DDSCodeTester.cpp
        :language: c++
        :start-after: //CONF-QOS-FLOWCONTROLLER
        :end-before: //!--
        :dedent: 8

    .. literalinclude:: /../code/XMLTester.xml
        :language: xml
        :start-after: <!-->CONF-QOS-FLOWCONTROLLER
        :end-before: <!--><-->
        :lines: 2-3, 5-
        :append: </profiles>

.. Warning::

   Specifying a flow controller with a size smaller than the transport buffer size
   can cause the messages to never be sent.
